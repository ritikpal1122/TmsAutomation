---
version: 0.1
globalTimeout: 90
testSuiteTimeout: 60
testSuiteStep: 10

runson: linux
autosplit: true
concurrency: 5

runtime:
  language: node
  version: "20"

env:
  TEST_ENV: stage
  TEST_SUITE: "@smoke"
  TEST_MODE: remote
  AUTH_EMAIL: ""
  AUTH_PASSWORD: ""
  AUTH_TOKEN: ""
  LT_USERNAME: ""
  LT_ACCESS_KEY: ""
  AUTH_URL: ""
  BASE_URL: ""
  TMS_BASE_URL: ""
  TMS_API_URL: ""
  TMS_INSIGHTS_API: ""
  HUB_URL: ""
  API_URL: ""
  REPORT_LAB_ENABLED: "true"
  REPORT_LAB_URL: ""
  SLACK_BOT_TOKEN: ""
  SLACK_CHANNEL: ""
  SLACK_MENTIONS: ""
  HE_BUILD_ID: ""

retryOnFailure: true
maxRetries: 2

mergeArtifacts: true
alwaysRunPostSteps: true

cacheKey: '{{ checksum "package-lock.json" }}'
cacheDirectories:
  - node_modules
  - /home/user/.cache/ms-playwright

globalPre:
  commands:
    - npm ci
    - npx playwright install chromium --with-deps
    - npx tsx scripts/report-lab.ts start

pre:
  - npx playwright test --project setup

testDiscovery:
  type: raw
  mode: dynamic
  command: grep -rl "${TEST_SUITE}" tests/ --include="*.spec.ts" | sed 's|tests/||'

testRunnerCommand: node scripts/run-tests.js --env $TEST_ENV --grep $TEST_SUITE --retries 2 -- tests/$test

post:
  - npx tsx scripts/report-lab.ts create_tests

globalPost:
  commands:
    - npx tsx scripts/report-lab.ts end
    - npx tsx scripts/report-lab.ts notify

uploadArtefacts:
  - name: report-lab-results
    path:
      - report-lab-results/
  - name: playwright-report
    path:
      - playwright-report/
  - name: allure-results
    path:
      - allure-results/
