---
version: 0.1
globalTimeout: 90
testSuiteTimeout: 60
testSuiteStep: 10

runson: linux
autosplit: true
concurrency: 5

runtime:
  language: node
  version: "20"

env:
  TEST_ENV: ${TEST_ENV}
  TEST_SUITE: ${TEST_SUITE}
  REPORT_LAB_ENABLED: "true"
  REPORT_LAB_URL: ${REPORT_LAB_URL}
  SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
  SLACK_CHANNEL: ${SLACK_CHANNEL}
  SLACK_MENTIONS: ${SLACK_MENTIONS}
  HE_BUILD_ID: ${HE_BUILD_ID}

cacheKey: '{{ checksum "package-lock.json" }}'
cacheDirectories:
  - node_modules
  - /home/user/.cache/ms-playwright

globalPre:
  - npm ci
  - npx playwright install chromium --with-deps
  - npx tsx scripts/report-lab.ts start

pre:
  - npx playwright test --project setup

testDiscovery:
  type: raw
  mode: dynamic
  command: grep -rl "${TEST_SUITE}" tests/ --include="*.spec.ts" | sed 's|tests/||'

testRunnerCommand: node scripts/run-tests.js --env $TEST_ENV --grep $TEST_SUITE --retries 2 -- tests/$test

post:
  - npx tsx scripts/report-lab.ts create_tests

globalPost:
  - npx tsx scripts/report-lab.ts end
  - npx tsx scripts/report-lab.ts notify

uploadArtefacts:
  - name: report-lab-results
    path:
      - report-lab-results/
  - name: playwright-report
    path:
      - playwright-report/
  - name: allure-results
    path:
      - allure-results/
