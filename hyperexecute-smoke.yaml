---
version: 0.1
globalTimeout: 30
testSuiteTimeout: 15
testSuiteStep: 5

runson: linux
autosplit: true
concurrency: 10

runtime:
  language: node
  version: "20"

env:
  TEST_ENV: ${TEST_ENV}
  TEST_SUITE: "@smoke"
  TEST_MODE: "remote"
  LT_PROFILE: ${LT_PROFILE}
  LT_RUN_PROFILE: "smoke"
  LT_BUILD_ID: ${LT_BUILD_ID}
  LT_USERNAME: ${LT_USERNAME}
  LT_ACCESS_KEY: ${LT_ACCESS_KEY}
  AUTH_EMAIL: ${AUTH_EMAIL}
  AUTH_PASSWORD: ${AUTH_PASSWORD}
  AUTH_TOKEN: ${AUTH_TOKEN}
  REPORT_LAB_ENABLED: "true"
  REPORT_LAB_URL: ${REPORT_LAB_URL}
  SLACK_BOT_TOKEN: ${SLACK_BOT_TOKEN}
  SLACK_CHANNEL: ${SLACK_CHANNEL}
  SLACK_MENTIONS: ${SLACK_MENTIONS}
  HE_BUILD_ID: ${HE_BUILD_ID}

cacheKey: '{{ checksum "package-lock.json" }}'
cacheDirectories:
  - node_modules
  - /home/user/.cache/ms-playwright

globalPre:
  - npm ci
  - npx playwright install chromium --with-deps
  - npx tsx scripts/report-lab.ts start

pre:
  - npx playwright test --project setup

testDiscovery:
  type: raw
  mode: dynamic
  command: node scripts/discover-tests.js --env $TEST_ENV --grep "@smoke"

testRunnerCommand: node scripts/run-tests.js --env $TEST_ENV --mode remote --run-profile smoke --grep "@smoke" --retries 1 -- tests/$test

post:
  - npx tsx scripts/report-lab.ts create_tests

globalPost:
  - npx tsx scripts/report-lab.ts end
  - npx tsx scripts/report-lab.ts notify

uploadArtefacts:
  - name: report-lab-results
    path:
      - report-lab-results/
  - name: playwright-report
    path:
      - playwright-report/
  - name: allure-results
    path:
      - allure-results/
